### 前言

该方案通过底盘电机反馈数据估计云台转速和绝对角度，旨在实现低成本的，不依赖于惯性或磁力计的导航，或者是在陀螺仪意外离线的情况下提供备用导航，同时也可为惯性六轴传感器提供可融合数据其提高精度

### 原理

一般目前我们采用麦克纳姆轮逆向运动学解算的矩阵如下（O-长方形安装，由于定义正方向为四个轮子前进方向，右侧轮子实际解算到3508电机的转向恰好相反，故右侧轮子的转速有一个负号）
$$
\begin{bmatrix}-\omega_{FR}\\\omega_{FL}\\\omega_{BL}\\-\omega_{BR}\end{bmatrix}=\frac{1}{r}
\begin{bmatrix}
1 & -1 & -K_{xy}\\
1 & 1 & K_{xy}\\
1 & -1 & K_{xy}\\
1 & 1 & -K_{xy}
\end{bmatrix}
\cdot\begin{bmatrix}v_x\\v_y\\\omega_z\end{bmatrix}\\
\\将负号移到逆向解算矩阵内可得\\
\begin{bmatrix}\omega_{FR}\\\omega_{FL}\\\omega_{BL}\\\omega_{BR}\end{bmatrix}=\frac{1}{r}
\begin{bmatrix}
-1 & 1 & K_{xy}\\
1 & 1 & K_{xy}\\
1 & -1 & K_{xy}\\
-1 & -1 & K_{xy}
\end{bmatrix}
\cdot\begin{bmatrix}v_x\\v_y\\\omega_z\end{bmatrix}\\
可以简写为\ \Omega = \frac{1}{r}R\cdot V\\
其中K_{xy}=abs(X_n)+abs(Y_n)，\\X_n和Y_n分别是第n个轮子到旋转轴的x方向距离和y方向距离
$$
逆向解算是将实际的三个速度解算到对应轮子的转速上，这个过程的逆过程是麦轮的正向解算，这里不说明具体推导过程，只给出正向解算的矩阵F
$$
V=r F \cdot\Omega \\
其中F=((R^TR)^{-1})R^T
$$

用Matlab的符号运算可以快速求出该矩阵

```matlab
syms k_xy
R=[1,-1,-k_xy;1,1,k_xy;1,-1,k_xy;1,1,-k_xy]
F=simplify(inv(transpose(R)*R)*transpose(R))

F =
[       -1/4,        1/4,        1/4,       -1/4]
[        1/4,        1/4,       -1/4,       -1/4]
[ 1/(4*k_xy), 1/(4*k_xy), 1/(4*k_xy), 1/(4*k_xy)]
```

其中最关键的是第三行即对应于计算w_z旋转速度，通过算出标准单位(rpm)的转速与云台电机反馈转速加/减可以求解出云台相对于地面的转速。可以看到在该坐标系定义下，w_z等于四轮转速之和除以四倍的k_xy。同理通过求解四个电机的角度差之和除以四倍的k_xy即可算出底盘转过的角度差，再与云台电机的角度差加/减即可获得绝对角度。角度差求解与转速直接积分求角度不同之处在于角度与转速的传感器来源不同，并且角度差求和不容易出现累计误差。这两者可以作为串级PID的反馈量控制底盘

### 实际参数获取与计算

如果要算出实际转速或者角度差，必须要公式中的具体参数。首先麦轮的半径，如果是官方麦轮这个可以直接看说明书获得。其次3508输出需要经减速，减速比也是可以看说明书获得。K_XY的值依不同底盘而异，这个需要询问机械组的同学

实际写到代码里也就一句话

```c
w_z=(D_WHEEL/2)*(chassis_wheel[0].speed_rpm + chassis_wheel[1].speed_rpm + chassis_wheel[2].speed_rpm + chassis_wheel[3].speed_rpm)/REDUCTION_RATIO/(4*KXY);
```

### 校准参数

在实际测试中由于各种各样的因素，比如麦轮小胶轮磨损或者掉落导致四个轮的半径变化，轮组机械装配误差或者变形，甚至麦轮打滑，实际代入得参数总是有误差，导致解算出来尤其是角度有明显误差，在实际控制中表现为云台的绝对角度相对于地面缓慢匀速漂移，这个在小陀螺模式下十分明显。仿照陀螺仪的方案，我们也可以对参数进行校准

不论是转速还是角度差计算，都是拿底盘四个轮子角度差/转速之和除以一个固定值加/减云台角度差/转速，3508电机本身反馈转速的测量误差可以通过校准电机实现，同时除的固定值可以通过测量云台稳定情况下的转速进行校准

一个目前测试可用的方案是，让Yaw轴云台电机无力，打开小陀螺，通过外力让云台相对于地面静止，比如用手扶稳云台。此时Yaw轴云台电机的转速和角度即可认为是底盘解算的精确值，采集云台电机数据和解算的角速度和角度。
$$
校准前\Delta\theta_{chassis}-\Delta\theta_{gimbal}=\omega_{drift}\Delta t\\
校准后\Delta\theta_{chassis}*k_{cal}-\Delta\theta_{gimbal}=0\\
k_{cal}=1-\frac{\omega_{drift}}{\omega_{chassis}}=1-\frac{\omega_{drift}\Delta t}{\Delta\theta_{chassis}}
$$
其中 $$\omega_{drift}$$ 为漂移的角速度，可以通过采集到的的数据中的解算角度进行线性回归求斜率求得，或者直接使用解算的转速求平均，但后者的噪声较大

由上面的推导可知，1减去精确转速和解算的转速求一段时间的平均值之比，就是校准需要转速或角度差的一个乘数，将这个校准值乘上底盘解算的转速或角度差即可

### 未来改进方向

该方案目前尚未成熟，在一次校准的情况下打开小陀螺，一分钟内仍然出现漂移接近半圈的情况。未来主要是在精度上改进，例如在当前校准方法上增加校准次数或校准数据采集时间，或者是实现一个更加系统的校准方法。但目前该方案在对大的连续漂移不敏感的云台上有可能完全替代IMU或AHRS，降低机器人成本并提高可靠性。另一种方向是数据融合，底盘解算的数据与磁力计数据相比有不受干扰，精度高，静止时漂移较小的明显优势，在以麦轮-两轴云台架构上可以替代磁力计，结合六轴的数据进行融合，改善精度。

